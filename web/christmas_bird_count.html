<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="christmas_bird_count.css"/>
<body>
  <div class="main">
    <div class="div-header">
      <div class="legend">  
        <p>Circle size represents the number of observations in a given year. Move the mouse over any row to see the counts.</p>
       <!--  <p>Circle size can scaled in two ways:</p>
        <div>
        <input type="radio" value="1" name="rad" checked>
        <div class="button-desc">
          The area of the largest circle represents the highest count for that species.
          This allows comparison between years for each species individually.
        </div>
        </div>
        <br><br>

        <div>
        <input type="radio" value="2" name="rad">
        <div class="button-desc">
          The area of the largest circle represents the highest count for any species. 
          This allows comparison between species. </div>
        </div>
        <br><br>
        <div>1h = 100 observations --------------- 1k = 1,000 observations --------------- CP = observed during count period</div> -->
      </div>
    </div>
    <div class="div-body"></div>
  </div>
</body>
<script src="d3.v3.min.js"></script>
<script>

var data_path = '../data/'; //dir_christmas_bird_count/

var margin_t = {top: 3, right: 210, bottom: 0, left: 10}, // table
  margin_a = {top: 27, right: 210, bottom: 0, left: 10}, // axis
  margin_h = {top: 10, right: 210, bottom: 12, left: 10}, // histogram
  width = 720 - margin_t.right - margin_t.left, // 1100
  height_t = 2600 - margin_t.top - margin_t.bottom,
  height_a = 40 - margin_a.top - margin_a.bottom,
  height_h = 100 - margin_h.top - margin_h.top,
  row_h = 20,
  circle_max_size = 5, //9;
  start_year = 1952,
  end_year = 2014,
  record_end = width + 50,
  species_start = width + 60;

var year_col_w, bar_val;

var window_width = window.innerWidth;

var x = d3.scale.linear()
  .range([0, width]);

var formatYears = d3.format("0000");

var xAxis = d3.svg.axis()
  .scale(x)
  .orient("top")
  .tickFormat(formatYears);

var svg_hist = create_svg(".div-header", margin_h, width, height_h);
var svg_header = create_svg(".div-header", margin_a, width, height_a);
var svg = create_svg(".div-body", margin_t, width, height_t);

d3.json(data_path + "web_data_cp.json", function(data) {

  x.domain([start_year, end_year]);

  year_col_w = x(2001) - x(2000);

  svg_header.append("g")
    .attr("class", "x axis")
    .call(xAxis);

  var header = svg_header.append("g").attr("class", "header");

  add_label(header, record_end, -15, "Max", "end", "label");
  add_label(header, record_end, 0, "Count", "end", "label");
  add_label(header, species_start, 0, "Species", "start", "label");

  draw_rows(1);

  // d3.selectAll("input").on("change", 
  //   function() { 
  //     draw_rows(this.value); }
  //   )

  function mouseover_2(p) {
    var year = d3.select(this).data()[0][0];
    var g = d3.select(this).node().parentNode;

    d3.select(g)
      .selectAll("circle")
      .filter(function(d) { return d[0] == year; })
      .attr("fill", "red")

    d3.select(g)
      .selectAll("text.value")
      .filter(function(d) { return d[0] == year; })
      .style("display", "block");
  }

  function mouseout_2(p) {
    var g = d3.select(this).node().parentNode;
    d3.select(g)
      .selectAll("circle")
      .attr("fill", function(d) {
        if (d[1] == d[2]) { return "green"; }
        return "grey";
      })
    d3.select(g).selectAll("text.value").style("display","none");
  }

  function draw_rows(value) {

    var rScale = d3.scale.pow().exponent(.5) // changed from .linear() which is wrong!!! the circle's area should map linearly to # of observations, not the radius!!!
      .range([0, circle_max_size]);
    svg.selectAll("g").remove();

    for (var j = 0; j < data.length; j++) {
      var g = svg.append("g").attr("class","species");

      if (value == 1) {
        rScale.domain([0, d3.max(data[j]['observations'], function(d) { return d[1]; })]);
      } else {
        rScale.domain([0, 3400]);
      }

      g.selectAll("circle")
        .data(data[j]['observations']) 
        .enter()
        .append("circle")
        .attr("cx", function(d) { return x(d[0]); })
        .attr("cy", (j+1)*row_h)
        .attr("r", function(d) { return rScale( (d[1]=='CP' ? 1 : d[1]) ); })
        .attr("fill", function(d) {
          if (d[1] == data[j]['max_count']) { return "green"; }
          return "grey";
        });

      g.selectAll("text")
        .data(data[j]['observations'])
        .enter()
        .append("text")
        .attr("text-anchor", "middle")
        .attr("y", (j+1)*row_h - circle_max_size - 1)//+ 5)
        .attr("x", function(d) { return x(d[0]); })
        .attr("class", "value")
        .text(function(d) { return val_formatter_2(d[1]); })
        .style("fill", "black")
        .style("display", "none");

      g.append("text")
        .attr("text-anchor", "end")
        .attr("y", (j+1)*row_h + 5)
        .attr("x", record_end)
        .attr("class", "column")
        .text(data[j]['max_count'])
        .style("fill", "green");

      g.append("text")
        .attr("y", (j+1)*row_h + 5)
        .attr("x", species_start)
        .attr("class", "label")
        .text(truncate(data[j]['name'], 30, "..."))
        .style("fill", "black");

      g.selectAll("rect")
        .data(data[j]['observations']) 
        .enter()
        .append("rect")
        .attr("x", function(d) { return x(d[0]) - year_col_w/2; })
        .attr("y", j*row_h+ row_h/2)
        .attr("width", year_col_w)
        .attr("height", row_h)
        .attr("opacity", 0)
        .on("mouseover", mouseover_2)
        .on("mouseout", mouseout_2)
    }
  };

  d3.json(data_path + "bar_data.json", function(bar_data) {

    var y = d3.scale.linear()
      .range([height_h, 0]);

    var button_container = d3.select(".div-header").append("div")
      .attr("class", "button-container")
      .style("left", (width+50) + "px")
      .style("top", (height_h) + "px");

    var rad_1 = button_container.append("div")
      .attr("class", "radio");
    rad_1.append("label")
      .append("input")
      .attr("type", "radio")
      .attr("name", "optradio")
      .attr("value", "1")
      .attr("checked", true)
    rad_1.append("div")
      .attr("class", "button-label")
      .text("Number of Species");

    var rad_2 = button_container.append("div")
      .attr("class", "radio");
    rad_2.append("label")
      .append("input")
      .attr("type", "radio")
      .attr("name", "optradio")
      .attr("value", "2")
    rad_2.append("div")
      .attr("class", "button-label")
      .text("Number of Birds");

    draw_bars(1);

    d3.selectAll(".button-container input").on("change", 
      function() { 
        draw_bars(this.value); }
    )

//       <div class="radio">
//   <label><input type="radio" name="optradio">Option 1</label>
// </div>
// <div class="radio">
//   <label><input type="radio" name="optradio">Option 2</label>
// </div>

    function draw_bars(val) {

      function accessor(d) {
        if (val == 1) {
          return d.n_spc;
        } else {
          return d.tot_count;
        }
      }

      svg_hist.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (height_h+5) + ")")
        .call(xAxis.orient("bottom"));
      
      y.domain([0, d3.max(bar_data, function(d) { return accessor(d); })]);

      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("right")
        .ticks(5)
        .tickFormat(val_formatter_1);
      
      svg_hist.selectAll("g").remove();

      svg_hist.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + (width+10)+ ", 0)")
        .call(yAxis);

      var bar = svg_hist.selectAll(".bar")
          .data(bar_data)
        .enter().append("g")
          .attr("class", "bar")
          .attr("transform", function(d) { return "translate(" + (x(d.yr)-year_col_w/2) + "," + y(accessor(d)) + ")"; });

      bar.append("rect")
        .attr("x", 1)
        .attr("width", year_col_w - 1)
        .attr("height", function(d) { return height_h - y(accessor(d)); });
    }

  })

});

function val_formatter_1(val) {
  if (val > 1000) { return val/1000 + 'k'; }
  return val;
}

function val_formatter_2(val) {
  if (val == 0) { return ''; }
  else { return val; }
}

function create_svg(id, margin, w, h) {
  return d3.select(id).append("svg")
           .attr("width", w + margin.left + margin.right)
           .attr("height", h + margin.top + margin.bottom)
           .append("g")
           .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
}

function truncate(str, maxLength, suffix) {
  if (str.length > maxLength) {
    str = str.substring(0, maxLength + 1); 
    str = str.substring(0, Math.min(str.length, str.lastIndexOf(" ")));
    str = str + suffix;
  }
  return str;
}

function add_label(selection, x, y, text, anchor, class_str) {
  return selection.append("text")
                  .attr("text-anchor", anchor)
                  .attr("y", y)
                  .attr("x", x)
                  .attr("class", class_str)
                  .style("fill", "black")
                  .text(text);
}

</script>
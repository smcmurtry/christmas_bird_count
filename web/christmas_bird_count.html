<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" type="text/css" href="icon.min.css"/>

<link rel="stylesheet" type="text/css" href="christmas_bird_count.css"/>
<title>Peterborough Christmas Bird Count</title>
<body>
  <div class="main">
    <div class="div-header">
      <h1>Peterborough Christmas Bird Count</h1>
      <div class="legend"> 
        <div class="select">Select the circle scale:</div>
        <div>
        <div><i class="sort icon" name='Max'>max</i></div>
        <div><i class="sort icon" name='Median'>median</i></div>
        <div><i class="sort icon" name='Species'>species</i></div>

          <div class="a">
            <input type="radio" value="1" name="rad" checked>
            <div class="button-desc">
              One scale for each species. This allows comparison between years for one species at a time.
            </div>
          </div>
          <div class="b">
            <input type="radio" value="2" name="rad">
            <div class="button-desc">
              One scale for entire chart. This allows comparison between species. </div>
            </div>
          </div>
        </div>
    </div>
    <div class="div-body"></div>

    <div>        
      <p>CP = observed in count period but not during the official count</p>
    </div>
  </div>
</body>
<script src="d3.v3.min.js"></script>
<script>

var data_path = '../data/'; //dir_christmas_bird_count/

var window_width;
if ((window.innerWidth-30) > 1400) { window_width = 1400; }
else { window_width = window.innerWidth - 30; } // this includes the left margin and vertical scrollbar


var margin_t = {top: 3, right: 260, bottom: 0, left: 10}, // table
  margin_a = {top: 27, right: 260, bottom: 0, left: 10}, // axis
  margin_h = {top: 13, right: 260, bottom: 12, left: 10}, // histogram
  width = window_width - margin_t.right - margin_t.left, // 1100
  height_t = 3000 - margin_t.top - margin_t.bottom,
  height_a = 30 - margin_a.top - margin_a.bottom,
  height_h = 100 - margin_h.top - margin_h.top,
  row_h = 20,
  circle_max_size = 8,
  start_year = 1952,
  end_year = 2014,
  record_end = width + 50,
  species_start = width + 60,
  button_legend_h = 150,
  width_max_col = 55,
  width_med_col = 60,
  col_spacing = 10,
  sort_dict = {'Max': {'ascending': 'max_sort_a', 'descending': 'max_sort_d'},
               'Median': {'ascending': 'median_sort_a', 'descending': 'median_sort_d'},
               'Species': {'ascending': 'species_sort_a', 'descending': 'species_sort_d'}};

var year_col_w, bar_val, sort_prop, scale_type;

sort_prop = 'orig_sort';
scale_type = 1;

var x = d3.scale.linear()
  .range([0, width]);

var formatYears = d3.format("0000");

var xAxis = d3.svg.axis()
  .scale(x)
  .orient("top")
  .tickFormat(formatYears);

var rScale = d3.scale.pow().exponent(.5) // changed from .linear() which is wrong!!! the circle's area should map linearly to # of observations, not the radius!!!
               .range([0, circle_max_size]);

var svg_hist = create_svg(".div-header", margin_h, width, height_h);
var svg_header = create_svg(".div-header", margin_a, width, height_a);
var svg = create_svg(".div-body", margin_t, width, height_t);



d3.json(data_path + "web_data_cp.json", function(data) {

  x.domain([start_year, end_year]);

  year_col_w = x(2001) - x(2000);

  svg_header.append("g")
    .attr("class", "x axis")
    .call(xAxis);

  var header = svg_header.append("g").attr("class", "header");

  add_label(header, record_end, -15, "Max", "end", "label");
  add_label(header, record_end, 0, "Count", "end", "label");
  add_label(header, record_end+width_max_col, -15, "Median", "end", "label");
  add_label(header, record_end+width_max_col, 0, "Count", "end", "label");
  add_label(header, record_end+width_max_col+col_spacing, 0, "Species", "start", "label");

  draw_rows();

  d3.selectAll("input").on("change", function() { 
    scale_type = this.value;
    set_circle_size();
  })

  d3.selectAll(".label").on("click", function() {
    var text = d3.select(this).text();
    sort_prop = sort_dict[text];
    set_y_position();
  })

  d3.selectAll(".sort")
  .on("click", function(p) {
    var sel = d3.select(this);
    if (sel.attr("class") == "sort icon" || sel.attr("class") == "sort descending icon") {
      d3.selectAll(".sort").attr("class", "sort icon");
      sel.attr("class", "sort ascending icon");
      sort_prop = sort_dict[sel.attr("name")]['ascending'];

    } else if ( sel.attr("class") == "sort ascending icon") {
      d3.selectAll(".sort").attr("class", "sort icon");
      sel.attr("class", "sort descending icon");
      sort_prop = sort_dict[sel.attr("name")]['descending']
    }
    set_y_position();
  })

  function set_y_position() {
    d3.selectAll("circle")
      .attr("cy", function(d) { return (d[sort_prop]+1)*row_h; });
    d3.selectAll(".mouse_rect")
      .attr("y", function(d) { return d[sort_prop]*row_h+ row_h/2; });
    d3.selectAll('.div-body .value')
      .attr("y", function(d) { return (d[sort_prop]+1)*row_h - circle_max_size - 1; });
    d3.selectAll(".column")
      .attr("y", function(d) { return (d[sort_prop]+1)*row_h + 5; });
    d3.selectAll(".text-rect")
      .attr("y", function(d) { return (d[sort_prop]+1)*row_h - circle_max_size - 12; } ) 
  }

  function set_circle_size() {
    d3.selectAll("circle")
      .attr("r", function(d) { 
        if (scale_type == 1) {
          rScale.domain([0, d.max_count]);
        } else {
          rScale.domain([0, 3400]);
        }
        return rScale( (d.count=='CP' ? 1 : d.count) ); 
      })
  }

  function mouseover_1(p) {
    var year = d3.select(this).data()[0].yr;

    d3.select(this)
      .attr("fill", "red");

    d3.select(".div-header")
      .selectAll("text.value")
      .filter(function(d) { return d.yr == year; })
      .style("display", "block");
  }

  function mouseover_2(p) {
    var year = d3.select(this).data()[0].year;
    var sort_i = d3.select(this).data()[0][sort_prop];

    d3.selectAll("circle")
      .filter(function(d) { return d.year == year && d[sort_prop] == sort_i; })
      .attr("fill", "red")

    d3.selectAll(".text-rect")
      .filter(function(d) { return d.year == year && d[sort_prop] == sort_i; })
      .style("display", "block");

    d3.selectAll("text.value")
      .filter(function(d) { return d.year == year && d[sort_prop] == sort_i; })
      .style("display", "block");
  }

  function mouseout_1(p) {
    d3.select(this).attr("fill", "grey");
    d3.select(".div-header").selectAll("text.value").style("display", "none");
  }

  function mouseout_2(p) {
    d3.selectAll("circle")
      .attr("fill", function(d) {
        if (d.count == d.median_count) { return "blue"; }
        else if (d.count == d.max_count) { return "green"; }
        return "grey";
      })
    d3.selectAll("text.value").style("display","none");
    d3.selectAll(".text-rect").style("display","none");

  }

  function compile_data() {
    var points = [],
        rows = [];

    for (var j = 0; j < data.length; j++) {
      
      var row = {};
      for (var k = Object.keys(data[j]).length - 1; k >= 0; k--) {
        var key = Object.keys(data[j])[k];
        if (key != 'observations') { row[key] = data[j][key]; }
        row['orig_sort'] = j;
      };
      rows.push(row);

      for (var i = 0; i < data[j]['observations'].length; i++) {
        var point = {};

        point['year'] = data[j]['observations'][i][0];
        point['count'] = data[j]['observations'][i][1];

        for (var k = Object.keys(row).length - 1; k >= 0; k--) {
          var key = Object.keys(row)[k];
          point[key] = row[key];
        };
        points.push(point);
      }
    }
    return [points, rows];
  }

  // function draw_header() {

  // }


  function draw_rows() {

    var res = compile_data();
    var points = res[0],
        rows = res[1];
    svg.selectAll("circle")
      .data(points)
      .enter()
      .append("circle")
      .attr("cx", function(d) { return x(d.year)})
      .attr("fill", function(d) {
        if (d.count == d.median_count) { return "blue"; }
        else if (d.count == d.max_count) { return "green"; }
        return "grey";
      });

    svg.selectAll(".text-rect")
      .data(points)
      .enter()
      .append("rect")
      .attr("class", "text-rect")
      .attr("x", function(d) { return x(d.year) - year_col_w/2; })
      .attr("width", function(d) { return (d.count > 0 || d.count == 'CP') ? circle_max_size*2 : 0; })
      .attr("height", 11)
      .style("fill", "white")
      .style("opacity", 0.5)
      .style("display", "none");

    svg.selectAll("value")
      .data(points)
      .enter()
      .append("text")
      .attr("text-anchor", "middle")
      .attr("x", function(d) { return x(d.year); })
      .attr("class", "value")
      .text(function(d) { return val_formatter_2(d.count); })
      .style("fill", "black")
      .style("display", "none");

    svg.selectAll('.column .max')
      .data(rows)
      .enter()
      .append("text")
      .attr("class", "column max")
      .attr("text-anchor", "end")
      .attr("x", record_end)
      .text(function(d) { return d.max_count; })
      .style("fill", "green");

    svg.selectAll('.column .median')
      .data(rows)
      .enter()
      .append("text")
      .attr("text-anchor", "end")
      .attr("x", record_end+width_max_col)
      .attr("class", "column median")
      .text(function(d) { return d.median_count; })
      .style("fill", "blue");

    svg.selectAll('.column .species')
      .data(rows)
      .enter()
      .append("text")
      .attr("x", species_start+width_max_col+col_spacing)
      .attr("class", "column species")
      .text(function(d) { return truncate(d.name, 30, "..."); })
      .style("fill", "grey");

    svg.selectAll(".mouse_rect")
      .data(points) 
      .enter()
      .append("rect")
      .attr("class", "mouse_rect")
      .attr("x", function(d) { return x(d.year) - year_col_w/2; })
      .attr("width", year_col_w)
      .attr("height", row_h)
      .attr("opacity", 0)
      .on("mouseover", mouseover_2)
      .on("mouseout", mouseout_2)

    set_y_position();
    set_circle_size();
  }

  d3.json(data_path + "bar_data.json", function(bar_data) {

    var y = d3.scale.linear()
      .range([height_h, 0]);

    var button_container = d3.select(".div-header").append("div")
      .attr("class", "button-container")
      .style("left", (width+50) + "px")
      .style("top", button_legend_h + "px");

    var rad_1 = button_container.append("div")
      .attr("class", "radio");
    rad_1.append("input")
      .attr("type", "radio")
      .attr("name", "optradio")
      .attr("value", "1")
      .attr("checked", true)
    rad_1.append("div")
      .attr("class", "button-label")
      .text("Number of Species");

    var rad_2 = button_container.append("div")
      .attr("class", "radio");
    rad_2.append("input")
      .attr("type", "radio")
      .attr("name", "optradio")
      .attr("value", "2")
    rad_2.append("div")
      .attr("class", "button-label")
      .text("Number of Birds");

    draw_bars(1);

    d3.selectAll(".button-container input").on("change", 
      function() { 
        draw_bars(this.value); }
    )

    function draw_bars(val) {

      function accessor(d) {
        if (val == 1) { return d.n_spc; } 
        else { return d.tot_count; }
      }

      svg_hist.selectAll("g").remove();
      svg_hist.selectAll("text").remove();

      svg_hist.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + (height_h+5) + ")")
        .call(xAxis.orient("bottom"));

      y.domain([0, d3.max(bar_data, function(d) { return accessor(d); })]);

      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("right")
        .ticks(5)
        .tickFormat(val_formatter_1);
      
      svg_hist.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + (width+10)+ ", 0)")
        .call(yAxis);

      var bar = svg_hist.selectAll(".bar")
          .data(bar_data)
        .enter().append("g")
          .attr("class", "bar")
          .attr("transform", function(d) { return "translate(" + (x(d.yr)-year_col_w/2) + "," + y(accessor(d)) + ")"; });

      svg_hist.selectAll("text")
        .data(bar_data, function(d) { return d.yr; })
        .enter()
        .append("text")
        .attr("text-anchor", "middle")
        .attr("y", function(d) { return y(accessor(d)) - 5; })
        .attr("x", function(d) { return x(d.yr); })
        .attr("class", "value")
        .text(function(d) { return accessor(d); })
        .style("fill", "black")
        .style("display", "none");

      bar.append("rect")
        .attr("x", 1)
        .attr("width", year_col_w - 2)
        .attr("height", function(d) { return height_h - y(accessor(d)); })
        .attr("fill", "grey")
        .on("mouseover", mouseover_1)
        .on("mouseout", mouseout_1);

    }
  })
});

function val_formatter_1(val) {
  return (val > 1000 ? val/1000+'k' : val); 
}

function val_formatter_2(val) {
  return (val == 0 ? '' : val);
}

function create_svg(id, margin, w, h) {
  return d3.select(id).append("svg")
           .attr("width", w + margin.left + margin.right)
           .attr("height", h + margin.top + margin.bottom)
           .append("g")
           .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
}

function truncate(str, maxLength, suffix) {
  if (str.length > maxLength) {
    str = str.substring(0, maxLength + 1); 
    str = str.substring(0, Math.min(str.length, str.lastIndexOf(" ")));
    str = str + suffix;
  }
  return str;
}

function add_label(selection, x, y, text, anchor, class_str) {
  return selection.append("text")
                  .attr("text-anchor", anchor)
                  .attr("y", y)
                  .attr("x", x)
                  .attr("class", class_str)
                  .text(text);
}

</script>